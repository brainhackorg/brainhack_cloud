<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.104.1"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/brainhack_cloud/favicons/favicon.ico><link rel=apple-touch-icon href=/brainhack_cloud/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/brainhack_cloud/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/brainhack_cloud/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/brainhack_cloud/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/brainhack_cloud/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/brainhack_cloud/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/brainhack_cloud/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/brainhack_cloud/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/brainhack_cloud/favicons/android-192x192.png sizes=192x192><title>HPC | Brainhack cloud</title><meta name=description content="High Performance Computing
"><meta property="og:title" content="HPC"><meta property="og:description" content="High Performance Computing
"><meta property="og:type" content="article"><meta property="og:url" content="http://brainhack.org/brainhack_cloud/tutorials/hpc/"><meta property="article:section" content="tutorials"><meta property="article:modified_time" content="2022-09-28T19:53:31-06:00"><meta property="og:site_name" content="Brainhack cloud"><meta itemprop=name content="HPC"><meta itemprop=description content="High Performance Computing
"><meta itemprop=dateModified content="2022-09-28T19:53:31-06:00"><meta itemprop=wordCount content="1514"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="HPC"><meta name=twitter:description content="High Performance Computing
"><link rel=preload href=/brainhack_cloud/scss/main.min.ac6aa4ebeae7c2e34878b1b842479bebe34635c9dba93329c527f28aef994c87.css as=style><link href=/brainhack_cloud/scss/main.min.ac6aa4ebeae7c2e34878b1b842479bebe34635c9dba93329c527f28aef994c87.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<link rel=stylesheet href=/css/prism.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-00000000-0","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/brainhack_cloud/><span class=navbar-logo></span><span class=font-weight-bold>Brainhack cloud</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/brainhack_cloud/tutorials/><span class=active>Tutorials</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/brainhack_cloud/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/brainhack_cloud/admins/><span>Admins</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/brainhackorg/brainhack_cloud target=_blank><i class='fab fa-github'></i><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://twitter.com/brainhackorg target=_blank><i class='fab fa-twitter'></i><span>News/Twitter</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/brainhack_cloud/offline-search-index.31a24ec25a41cf194c58c6053de5812f.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/brainhack_cloud/offline-search-index.31a24ec25a41cf194c58c6053de5812f.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-brainhack_cloudtutorials-li><a href=/brainhack_cloud/tutorials/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-brainhack_cloudtutorials><span>Tutorials</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-brainhack_cloudtutorialsvm-li><a href=/brainhack_cloud/tutorials/vm/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-brainhack_cloudtutorialsvm><span>Virtual machines</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-brainhack_cloudtutorialsnotebooks-li><a href=/brainhack_cloud/tutorials/notebooks/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-brainhack_cloudtutorialsnotebooks><span>Notebooks</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-brainhack_cloudtutorialsgh_runner-li><a href=/brainhack_cloud/tutorials/gh_runner/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-brainhack_cloudtutorialsgh_runner><span>Github action runner</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-brainhack_cloudtutorialshpc-li><a href=/brainhack_cloud/tutorials/hpc/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-brainhack_cloudtutorialshpc><span class=td-sidebar-nav-active-item>HPC</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-brainhack_cloudtutorialsneurodesk-li><a href=/brainhack_cloud/tutorials/neurodesk/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-brainhack_cloudtutorialsneurodesk><span>Neurodesk</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/brainhackorg/brainhack_cloud/tree/main/content/en/tutorials/hpc.md class=td-page-meta--view target=_blank rel=noopener><i class="fa fa-file-alt fa-fw"></i> View page source</a>
<a href=https://github.com/brainhackorg/brainhack_cloud/edit/main/content/en/tutorials/hpc.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/brainhackorg/brainhack_cloud/new/main/content/en/tutorials/hpc.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/brainhackorg/brainhack_cloud/issues/new?title=HPC" class=td-page-meta--issue target=_blank rel=noopener><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/brainhackorg/brainhack_cloud/issues/new class=td-page-meta--project-issue target=_blank rel=noopener><i class="fas fa-tasks fa-fw"></i> Create project issue</a>
<a id=print href=http://brainhack.org/brainhack_cloud/tutorials/_print/><i class="fa fa-print fa-fw"></i> Print entire section</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#before-you-get-started>Before you get started</a></li><li><a href=#configure-hpc-cluster>Configure HPC cluster</a></li><li><a href=#configuring-node-memory>Configuring node memory</a></li><li><a href=#configuring-x11-forwarding>Configuring X11 forwarding</a></li><li><a href=#troublehsooting-editing-a-deployd-stack-fails>Troublehsooting: Editing a deployd stack fails</a></li><li><a href=#installing-custom-software>Installing Custom Software</a><ul><li><a href=#install-singularity>Install Singularity</a></li></ul></li><li><a href=#advanced-use-mpi-networking>Advanced: Use MPI networking</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><h1>HPC</h1><div class=lead>High Performance Computing</div><header class=article-meta></header><h2 id=overview>Overview</h2><p>Oracle cloud supports High Performance Computing and makes it very easy to setup
your own HPC cluster in the cloud. This tutorial here is a basic introduction to get your started. You can find an alternative setup (tailored at deep learning and GPUs here: <a href="https://docs.oracle.com/en/solutions/hpc-bare-metal-gpu-cluster/?source=:so:ch:or:awr::::Cloud&SC=:so:ch:or:awr::::Cloud&pcode=#GUID-F00DA828-106C-40CB-9279-B90D10807358">GPU cluster</a>)</p><h2 id=before-you-get-started>Before you get started</h2><p>Consider if you actually need High Performance Computing (HPC) for your work. An HPC is a cluster consisting of multiple machines and it uses a head-node (here bastion host) from where jobs are submitted to this cluster using a job engine (for example slurm). If you have many jobs that need to be run independently than the setup described here will work well. A &ldquo;real&rdquo; HPC does more on top: There is a high-performance network between machines and it enables to run jobs that combine multiple machines (e.g. MPI). This would be needed if you have a problem that&rsquo;s so large that a single machine wouldn&rsquo;t be big enough. In this example here we build a cluster without this advanced networking. Most people will not need an HPC for their work and they should use a single <a href=http://brainhack.org/brainhack_cloud/tutorials/vm/>virtual machine</a>, because it requires considerably less setup work and easier to maintain.</p><h2 id=configure-hpc-cluster>Configure HPC cluster</h2><p>Download the Terraform configuration from here as a zip file:
<a href=https://github.com/oracle-quickstart/oci-hpc/releases/tag/v2.9.2>https://github.com/oracle-quickstart/oci-hpc/releases/tag/v2.9.2</a></p><p>Make sure you selected the geographic region where you would like to create the resource (it should be close to you for best latencies).
<img src=https://user-images.githubusercontent.com/4021595/157349780-69fdf973-d4aa-4850-9f49-8ecca369f399.png alt=image></p><p>Then go to <code>Stacks</code> under <code>Resource Manager</code>:
<img src=https://user-images.githubusercontent.com/4021595/161415757-409d264d-39e0-41f0-8bb0-3b5adc53abde.png alt=image></p><p>In the <code>List Scope</code> drop down menu, select your project compartment. Click <code>Create Stack</code> and upload the zip file as a Terraform configuration source.</p><img width=1043 alt="create stack" src=https://user-images.githubusercontent.com/4021595/184516975-a8188aa9-8337-4523-9111-fb7a1c7868ba.png><p>give your cluster a name, but leave the default options for the rest:</p><img width=846 alt="naming the cluster" src=https://user-images.githubusercontent.com/4021595/184517026-76cc8d32-b19d-48a4-b4c3-8b88d0131ba1.png><p>Check that the cluster is being created in your compartment again and then hit <code>Next</code></p><p>In <code>cluster configuration</code> you need to add your public SSH key for the opc admin account. Make sure to setup your SSH keys first <a href=http://brainhack.org/brainhack_cloud/tutorials/vm/#create-a-public-key>create a public key</a></p><img width=852 alt=image src=https://user-images.githubusercontent.com/4021595/184517096-e62de0bf-e535-4aaa-84fc-70001e142051.png><p>In <code>Headnode options</code> you need to select an Availability Domain. It doesn&rsquo;t matter what you select there and the options will depend on the geographic region where you launch your HPC. You can keep the headnode default size, or you can select a different flavour:</p><img width=849 alt=image src=https://user-images.githubusercontent.com/4021595/184517208-247ffd57-56a6-44b2-a9a5-259ee728e00a.png><p>In <code>Compute node options</code> you need to disable <code>Use cluster network</code> (this is for MPI and not required for most people. It requires special network hardware that&rsquo;s not available in every region. If you need MPI please get in touch and we can help you setting this up). Select a compute node size that fits your problem size. Drop the initial compute size node to 1, because we will scale the cluster using autoscaling.</p><img width=829 alt=image src=https://user-images.githubusercontent.com/4021595/184517285-b6805297-1a16-4f29-aa4c-816334b28e86.png><p>In <code>Autoscaling</code> you should enable <code>scheduler based autoscaling</code>, <code>monitor the autoscaling</code> and disable <code>RDMA latency check</code> if you are not using MPI.</p><img width=847 alt=image src=https://user-images.githubusercontent.com/4021595/184517301-b08cf59e-f07f-42c4-865b-64a88e466274.png><p>For <code>API authentication</code> and <code>Monitoring</code> leave the defaults:</p><img width=851 alt=image src=https://user-images.githubusercontent.com/4021595/184517316-b8a93508-17a7-44a6-8024-0a01f3e01a06.png><p>For <code>Additional file system</code> accept the defaults:</p><img width=848 alt=image src=https://user-images.githubusercontent.com/4021595/184517726-d07ad10f-dc95-48ec-97fd-85e5ee19a6b9.png><p>For <code>Advanced bastion options</code>, <code>Avanced storage options</code> and <code>Network options</code> you can accept the defaults:</p><img width=836 alt=image src=https://user-images.githubusercontent.com/4021595/184517368-589f1876-d703-4560-86c9-60cb23a0c711.png><p>For <code>Software</code> enable <code>Install Spack package manager</code> in addition to the defaults:</p><img width=843 alt=image src=https://user-images.githubusercontent.com/4021595/184517390-d36d605d-e51b-46aa-84bf-140b2b711065.png><p>Then hit <code>next</code> and on the next page scroll to the end and tick <code>Run apply</code>:</p><img width=848 alt=image src=https://user-images.githubusercontent.com/4021595/184517402-a02367f8-d3df-4436-9cf6-356994172b1e.png><p>Then hit <code>Create</code></p><p>This will then create a custom HPC for your project (it will take a couple of minutes to complete).</p><p>Once everything is done you find the bastion IP (the &ldquo;head node&rdquo; or &ldquo;login node&rdquo;) under Outputs:
<img src=https://user-images.githubusercontent.com/4021595/161416418-6fcf7712-646d-48ea-9861-743fd679ba28.png alt=image></p><p>You can now ssh into the HPC as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>ssh opc@ipbastion
</span></span></code></pre></div><p>Be aware that this &ldquo;opc&rdquo; account is the admin account with sudo access of the cluster and should not be used to perform analyses. It is better to create a user account to perform the work in:</p><p>Once logged in with the opc account, you can create normal cluster users using the <code>cluster</code> command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>cluster user add test
</span></span></code></pre></div><p>These users can then login using a password only and do not require an SSH key.</p><p>There is a shared file storage (which can also be configured in size in the stack settings) in /nfs/cluster</p><p>More information can be found here:
<a href=https://github.com/oracle-quickstart/oci-hpc>https://github.com/oracle-quickstart/oci-hpc</a></p><h2 id=configuring-node-memory>Configuring node memory</h2><p>When you first submit jobs using <code>sbatch</code>, if you followed the above setup you may find you recieve the following error:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>error: Memory specification can not be satisfied
</span></span></code></pre></div><p>This is happening as the <code>RealMemory</code> for each node (e.g. the amount of memory each compute node may use) has not yet been specified and defaults to a very low value. To rectify this, first work out how much memory to allocate to each node by running <code>scontrol show nodes</code> and looking at <code>FreeMem</code>.
<img src=https://user-images.githubusercontent.com/4021595/176095292-c17e658b-0372-4c04-9f51-32d00c2e0f1c.png alt=image></p><p>To change the <code>RealMemory</code>, you must edit the slurm configuration file (which may be found in <code>/etc/slurm/slurm.conf</code>). Inside the slurm configuration file you will find several lines which begin <code>NodeName=</code>. These specify the settings for each node. To fix the error, on each of these lines, add <code>RealMemory=AMOUNT</code> where <code>AMOUNT</code> is the amount of memory you wish to allow the node to use.
<img src=https://user-images.githubusercontent.com/4021595/176095320-b9f55fb1-7365-4e8a-9a30-eee5117c12dc.png alt=image></p><p>Once you have done this, you must reconfigure slurm by running the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>sudo scontrol reconfigure
</span></span></code></pre></div><h2 id=configuring-x11-forwarding>Configuring X11 forwarding</h2><p>If you want to use graphical aplications you need to install:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>sudo yum install install mesa-dri-drivers xorg-x11-server-Xorg xorg-x11-xauth xorg-x11-apps mesa-libGL xorg-x11-drv-nouveau.x86_64 -y
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>sudo vi /etc/ssh/sshd_config
</span></span></code></pre></div><p>change to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>X11Forwarding yes 
</span></span><span style=display:flex><span>X11UseLocalhost no
</span></span></code></pre></div><p>then</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>sudo systemctl restart sshd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># or 
</span></span><span style=display:flex><span>sudo service sshd restart
</span></span></code></pre></div><p>For full functionality, you may also need to add <code>PrologFlags=X11</code> to your <code>/etc/slurm/slurm.conf</code>, along with enabling the following
additional parameters in you <code>/etc/ssh/sshd_config</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>AllowAgentForwarding yes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>AllowTcpForwarding yes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>X11Forwarding yes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>X11DisplayOffset 10
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>X11UseLocalhost no
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>On you main node, to restart slurm:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>```console
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>sudo slurmctld restart
</span></span></span></code></pre></div><p>And on your worker nodes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>sudo service slurmd restart
</span></span></code></pre></div><p>After you&rsquo;ve updated slurm, you can confirm the Prolog setting has taken:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>sudo scontrol reconfigre; sudo scontrol show config | grep PrologFlags
</span></span></code></pre></div><p>And also check that x11 works!</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>srun --x11 xeyes
</span></span></code></pre></div><h2 id=troublehsooting-editing-a-deployd-stack-fails>Troublehsooting: Editing a deployd stack fails</h2><p>This can have many reasons, but the first one to check is:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Error: 409-Conflict, The Instance Configuration ocid1.instanceconfiguration.oc1.phx.aaaaaaaabycbnzxq4uskt4f7mklp4g4fcqk4m42aabj2r2fkchjygppdudua is associated to one or more Instance Pools.
</span></span></code></pre></div><p>This means that the Instance Pool blocks the terraform script. To get it back working you need to destroy the stack first and then rebuild it.</p><p>Another option is that the resource type you used is not supported:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Error: 400-InvalidParameter, Shape VM.Standard1.4 is incompatible with image ocid1.image.oc1..aaaaaaaamy4z6turov5otuvb3wlej2ipv3534agxcd7loajk2f54bfmlyhnq
</span></span><span style=display:flex><span>Suggestion: Please update the parameter(s) in the Terraform config as per error message Shape VM.Standard1.4 is incompatible with image ocid1.image.oc1..aaaaaaaamy4z6turov5otuvb3wlej2ipv3534agxcd7loajk2f54bfmlyhnq
</span></span></code></pre></div><p>Here, I selected a shape that is too &ldquo;small&rdquo; and it fails. It needs at least VM.Standard2.4</p><h2 id=installing-custom-software>Installing Custom Software</h2><p>If you don&rsquo;t want to use spack (or cannot) then a good strategy is to install under <code>/nfs/cluster</code>, add any relevant &ldquo;bin&rdquo; directories it to your path, and install there.
As an example we will install <a href=https://go.dev/doc/install>go</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#204a87>cd</span> /nfs/cluster
</span></span><span style=display:flex><span>$ wget https://go.dev/dl/go1.19.linux-amd64.tar.gz
</span></span><span style=display:flex><span>$ sudo tar -C /nfs/cluster -xzf go1.19.linux-amd64.tar.gz
</span></span><span style=display:flex><span>$ rm go1.19.linux-amd64.tar.gz
</span></span></code></pre></div><p>And then add the go bin to your bash profile (<code>vim ~/.bash_profile</code>) as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>PATH</span><span style=color:#ce5c00;font-weight:700>=</span>/nfs/cluster/go/bin:<span style=color:#000>$PATH</span>
</span></span></code></pre></div><p>and when you open a new shell or <code>source ~/.bash_profile</code> you should be able to see go on your path:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ which go
</span></span><span style=display:flex><span>/nfs/cluster/go/bin/go
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go version
</span></span><span style=display:flex><span>go version go1.19 linux/amd64
</span></span></code></pre></div><p>Further, since it&rsquo;s located in the /nfs/cluster directory, it will be available on other nodes! Here is how to see the other nodes you have:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sinfo
</span></span><span style=display:flex><span>PARTITION AVAIL  TIMELIMIT  NODES  STATE NODELIST
</span></span><span style=display:flex><span>compute*     up   infinite      <span style=color:#0000cf;font-weight:700>1</span>   idle compute-permanent-node-941
</span></span></code></pre></div><p>And then shell into one, and also find the go binary.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ssh compute-permanent-node-941
</span></span><span style=display:flex><span>Last login: Sun Aug <span style=color:#0000cf;font-weight:700>14</span> 02:30:01 <span style=color:#0000cf;font-weight:700>2022</span> from relative-flamingo-bastion.public.cluster.oraclevcn.com
</span></span><span style=display:flex><span>$ which go
</span></span><span style=display:flex><span>/nfs/cluster/go/bin/go
</span></span></code></pre></div><h3 id=install-singularity>Install Singularity</h3><p>First, system dependencies. Follow the example above in <a href=#installing-custom-software>install custom software</a> to install Go.
Next, install Singularity dependencies. These will need to be installed to each node.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum groupinstall -y <span style=color:#4e9a06>&#39;Development Tools&#39;</span>
</span></span><span style=display:flex><span>sudo yum install libseccomp-devel squashfs-tools cryptsetup -y
</span></span><span style=display:flex><span>sudo yum install glib2-devel -y
</span></span></code></pre></div><p>Ensure Go is on your path (as shown above). Then install Singularity. We will install from source.</p><p><strong>Important</strong> ensure you don&rsquo;t have anything (e.g., pkg-config) loaded from spack, as this can interfere with installing Singularity using system libs. Also note that installing with system libs is a workaround for spack singularity not working perfectly (due to setuid). This means you&rsquo;ll need to do these steps on each of your head login and worker nodes.</p><p>You can do the same with an official <a href=https://github.com/sylabs/singularity/releases/>release</a>.
Note that you don&rsquo;t need to compile this on the nfs node - you can compile it anywhere and make install
to /nfs/cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ git clone https://github.com/sylabs/singularity
</span></span><span style=display:flex><span>$ <span style=color:#204a87>cd</span> singularity
</span></span><span style=display:flex><span>$ git submodule update --init
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># You can also set prefix to be it&#39;s own directory, e.g., /nfs/cluster/singularity-&lt;version&gt;</span>
</span></span><span style=display:flex><span>$ ./mconfig --prefix<span style=color:#ce5c00;font-weight:700>=</span>/nfs/cluster
</span></span><span style=display:flex><span>$ <span style=color:#204a87>cd</span> ./builddir
</span></span><span style=display:flex><span>$ make
</span></span><span style=display:flex><span>$ make install
</span></span></code></pre></div><p>Once you install, make sure you add the newly created bin to your path (wherever that happens to be). E.g.,
that might look like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>PATH</span><span style=color:#ce5c00;font-weight:700>=</span>/nfs/cluster/go/bin:/nfs/cluster/bin:<span style=color:#000>$PATH</span>
</span></span></code></pre></div><p>And then when you source your <code>~/.bash_profile</code> you can test:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ which singularity
</span></span><span style=display:flex><span>/nfs/cluster/bin/singularity
</span></span></code></pre></div><h2 id=advanced-use-mpi-networking>Advanced: Use MPI networking</h2><p>Your first need to request access to those resources with this
<a href=./../../docs/request>form</a>.</p><p>Then follow the above instructions, but leave <code>Use cluser network</code> activated and <code>RDMA options enabled</code>.</p><div class="text-muted mt-5 pt-3 border-top">Last modified September 28, 2022: <a href=https://github.com/brainhackorg/brainhack_cloud/commit/be06344f769d19123022b9eb4966b64d774a2865>Add more notes on x11 setup (be06344)</a></div></div></main></div></div><footer class="bg-dark py-4 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2 my-auto"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label><a class=text-white target=_blank rel=noopener href aria-label><i></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://twitter.com/brainhackorg aria-label=Twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label><a class=text-white target=_blank rel=noopener href aria-label><i></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3 my-auto"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/brainhackorg/brainhack_cloud aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label><a class=text-white target=_blank rel=noopener href aria-label><i></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Dicussion Forum (requires github login)" aria-label="Dicussion Forum (requires github login)"><a class=text-white target=_blank rel=noopener href=https://github.com/brainhackorg/brainhack_cloud/discussions aria-label="Dicussion Forum (requires github login)"><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2 my-auto"><small class=text-white>&copy; 2022 Brainhack Cloud<br>Except where otherwise noted, content on this site is licensed under a <a href=https://creativecommons.org/licenses/by/4.0/>CC BY 4.0 license</a>.</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/brainhack_cloud/js/main.min.0d626687ffb089f2a85c2441d596cc7e2218d32716e3a26b4623c159ada50846.js integrity="sha256-DWJmh/+wifKoXCRB1ZbMfiIY0ycW46JrRiPBWa2lCEY=" crossorigin=anonymous></script>
<script src=/js/prism.js></script></body></html>